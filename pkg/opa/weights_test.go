package opa

import (
	"fmt"
	"testing"
)

func TestWeights(t *testing.T) {
	testCases := []struct {
		payload string
		err     error
	}{
		//single change
		{"[{\"validation_pass\":false,\"weights\":[ {\"azurerm_app_service\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_app_service_plan\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_app_service_slot\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_application_insights\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_container_registry\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_data_factory\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_databricks_workspace\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_function_app\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_function_app_slot\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_key_vault\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_key_vault_access_policy\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_key_vault_secret\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_kubernetes_cluster\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_kubernetes_cluster_node_pool\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_log_analytics_workspace\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_mssql_database\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_mssql_server\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_nat_gateway\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_notification_hub_namespace\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_resource_group\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_servicebus_namespace\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_servicebus_queue\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_servicebus_subscription\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_servicebus_topic\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_sql_failover_group\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_storage_account\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_storage_container\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_subnet\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_virtual_network\": {\"create\": 0, \"delete\": 99, \"modify\": 99}}], \"data\": {\"address\": \"azurerm_resource_group.brad_test\", \"change\": {\"actions\": [\"delete\"], \"after\": null, \"after_sensitive\": false, \"after_unknown\": {}, \"before\": {\"id\": \"/subscriptions/57b482cf-3355-4f0c-8adb-6d6bbb1b2cf7/resourceGroups/brad-test\", \"location\": \"southcentralus\", \"name\": \"brad-test\", \"tags\": {}, \"timeouts\": null}, \"before_sensitive\": {\"tags\": {}}}, \"mode\": \"managed\", \"name\": \"brad_test\", \"provider_name\": \"registry.terraform.io/hashicorp/azurerm\", \"type\": \"azurerm_resource_group\"}}]", nil},
		// multiple change
		{"[{\"validation_passed\":false,\"weights\":[{\"azurerm_app_service\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_app_service_plan\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_app_service_slot\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_application_insights\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_container_registry\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_data_factory\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_databricks_workspace\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_function_app\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_function_app_slot\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_key_vault\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_key_vault_access_policy\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_key_vault_secret\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_kubernetes_cluster\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_kubernetes_cluster_node_pool\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_log_analytics_workspace\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_mssql_database\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_mssql_server\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_nat_gateway\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_notification_hub_namespace\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_resource_group\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_servicebus_namespace\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_servicebus_queue\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_servicebus_subscription\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_servicebus_topic\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_sql_failover_group\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_storage_account\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_storage_container\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_subnet\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_virtual_network\": {\"create\": 0, \"delete\": 99, \"modify\": 99}}], \"data\": {\"address\": \"azurerm_mssql_server.brad_test1\", \"change\": {\"actions\": [\"delete\"], \"after\": null, \"after_sensitive\": false, \"after_unknown\": {}, \"before\": {\"id\": \"/subscriptions/57b482cf-3355-4f0c-8adb-6d6bbb1b2cf7/resourceGroups/brad-test\", \"location\": \"southcentralus\", \"name\": \"brad-test\", \"tags\": {}, \"timeouts\": null}, \"before_sensitive\": {\"tags\": {}}}, \"mode\": \"managed\", \"name\": \"brad_test\", \"provider_name\": \"registry.terraform.io/hashicorp/azurerm\", \"type\": \"azurerm_mssql_server\"} },{\"validation_passed\":false,\"weights\":[{\"azurerm_app_service\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_app_service_plan\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_app_service_slot\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_application_insights\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_container_registry\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_data_factory\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_databricks_workspace\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_function_app\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_function_app_slot\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_key_vault\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_key_vault_access_policy\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_key_vault_secret\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_kubernetes_cluster\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_kubernetes_cluster_node_pool\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_log_analytics_workspace\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_mssql_database\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_mssql_server\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_nat_gateway\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_notification_hub_namespace\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_resource_group\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_servicebus_namespace\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_servicebus_queue\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_servicebus_subscription\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_servicebus_topic\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_sql_failover_group\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_storage_account\": {\"create\": 0, \"delete\": 99, \"modify\": 1}, \"azurerm_storage_container\": {\"create\": 0, \"delete\": 1, \"modify\": 0}, \"azurerm_subnet\": {\"create\": 0, \"delete\": 99, \"modify\": 99}, \"azurerm_virtual_network\": {\"create\": 0, \"delete\": 99, \"modify\": 99}}], \"data\": {\"address\": \"azurerm_resource_group.brad_test\", \"change\": {\"actions\": [\"delete\"], \"after\": null, \"after_sensitive\": false, \"after_unknown\": {}, \"before\": {\"id\": \"/subscriptions/57b482cf-3355-4f0c-8adb-6d6bbb1b2cf7/resourceGroups/brad-test\", \"location\": \"southcentralus\", \"name\": \"brad-test\", \"tags\": {}, \"timeouts\": null}, \"before_sensitive\": {\"tags\": {}}}, \"mode\": \"managed\", \"name\": \"brad_test\", \"provider_name\": \"registry.terraform.io/hashicorp/azurerm\", \"type\": \"azurerm_resource_group\"}}]", nil},
	}

	for _, tc := range testCases {
		weights := GetWeights(tc.payload)
		for _, weight := range weights {
			fmt.Println(weight.Service)
		}
	}
}
